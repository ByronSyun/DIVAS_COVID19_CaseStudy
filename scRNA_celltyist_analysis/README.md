# Single-cell RNA-seq Cell Type Analysis with DIVAS

This directory contains the complete workflow for single-cell RNA-seq cell type analysis using CellTypist annotation and DIVAS integration.

## Overview

This analysis workflow:
1. **Annotates cell types** using CellTypist PBMC model
2. **Prepares 6-block DIVAS input** combining T1 and T2 timepoints (114 samples)
3. **Runs DIVAS analysis** on 4 cell types + 2 bulk omics datasets

## Directory Structure

```
scRNA_celltyist_analysis/
â”œâ”€â”€ celltype_annotation/          # CellTypist annotation workflow
â”‚   â”œâ”€â”€ run_celltypist_pbmc.py    # Main annotation script
â”‚   â”œâ”€â”€ Adult_COVID19_PBMC.pkl    # CellTypist PBMC model
â”‚   â”œâ”€â”€ annotated_data_majority_voting/  # Output: annotated .h5ad files (user-generated)
â”‚   â””â”€â”€ README.md                 # Detailed annotation instructions
â”œâ”€â”€ T1T2_preparation/             # T1+T2 combined data preparation
â”‚   â”œâ”€â”€ combine_t1_t2_data.R      # Main preparation script (8634 genes, 114 samples)
â”‚   â””â”€â”€ balanced_sample_selection_114.csv  # Sample selection configuration
â”œâ”€â”€ DIVAS_run/                    # DIVAS analysis
â”‚   â”œâ”€â”€ run_combined_6block_divas.R       # Main DIVAS analysis script
â”‚   â”œâ”€â”€ divas_input_T1T2combined/         # 6-block input data (44MB, included)
â”‚   â””â”€â”€ divas_results/                    # DIVAS output (user-generated)
â””â”€â”€ README.md                     # This file
```

## Quick Start

### Prerequisites

- **R** (>= 4.0) with DIVAS package installed
- **Python** (>= 3.8) with scanpy, celltypist, pandas
- **Preprocessed scRNA-seq data**: `.h5ad` files in `../../preprocessing/process_sc/sc_gex_processing/processed_gex_data/`

### Installation

```bash
# Install DIVAS package
R -e "library(devtools); install_github('ByronSyun/DIVAS_Develop/pkg', ref = 'main')"

# Install Python dependencies
pip install scanpy celltypist pandas numpy
```

### Complete Workflow

#### Step 1: Cell Type Annotation (Run once)
```bash
cd celltype_annotation
python run_celltypist_pbmc.py
```

**Output**: Annotated `.h5ad` files in `annotated_data_majority_voting/`

#### Step 2: Prepare 6-block DIVAS Input (114 samples, 8634 genes)
```bash
cd ../T1T2_preparation
Rscript combine_t1_t2_data.R
```

**Output**: 6 CSV files in `../DIVAS_run/divas_input_T1T2combined/`

#### Step 3: Run DIVAS Analysis
```bash
cd ../DIVAS_run
Rscript run_combined_6block_divas.R
```

**Output**: DIVAS results in `divas_results/`

## Key Features

### ðŸ”¬ **Cell Type Analysis**
- **4 Major Cell Types**: CD4+ T, CD8+ T, CD14+ Monocytes, NK cells
- **Automated Annotation**: CellTypist PBMC model with majority voting
- **Quality Control**: Sample coverage and cell type distribution checks

### ðŸ“Š **6-block DIVAS Integration**
- **scRNA-seq Blocks**: 4 cell type-specific expression profiles (8634 genes each)
- **Bulk Omics Blocks**: Proteomics (481 features) + Metabolomics (763 features)
- **Sample Design**: 114 samples (57 T1 + 57 T2) from balanced selection

### âš¡ **Streamlined Workflow**
- **Direct Processing**: Reads directly from `.h5ad` files, no intermediate steps
- **Pre-computed Results**: 44MB input data included for immediate DIVAS analysis
- **Comprehensive Output**: Joint components, loadings, and diagnostic plots

## Data Requirements

### Input Data (Must be Generated)
- **Single-cell data**: `.h5ad` files from GEX preprocessing workflow
- **Bulk omics data**: Proteomics and metabolomics from preprocessing workflow

### Output Data (Generated by Scripts)
- **Annotated cells**: `annotated_data_majority_voting/*.h5ad` (~large files, not in Git)
- **DIVAS input**: `divas_input_T1T2combined/*.csv` (44MB total, included in Git)
- **DIVAS results**: `divas_results/*.rds` (analysis output, not in Git)

## Results Overview

### Joint Component Analysis
The DIVAS analysis identifies:
- **6-way components**: Shared across all data blocks
- **5-way components**: Complex multi-block patterns (4 components found)
- **2-4 way components**: Specific multi-block relationships
- **Total**: 29 joint components capturing different levels of integration

### Key Findings
- **8634 genes**: Comprehensive gene coverage after common gene filtering
- **114 samples**: Balanced T1/T2 design for temporal analysis  
- **Novel 5-way pattern**: CD14_Monocyte+NK+proteomics+metabolomics (innate immunity-metabolism axis)

## Troubleshooting

### Common Issues

1. **Missing `.h5ad` files**:
   ```bash
   # Run GEX preprocessing first
   cd ../../preprocessing/process_sc/sc_gex_processing
   python batch_process_gex.py
   ```

2. **CellTypist model download**:
   ```python
   import celltypist
   celltypist.models.download_models(force_update=True)
   ```

3. **Memory issues with large files**:
   - Ensure sufficient RAM (>16GB recommended)
   - Use `backed='r'` mode for reading large `.h5ad` files

### File Size Notes

- **Large files excluded from Git**:
  - `annotated_data_majority_voting/` (several GB)
  - `divas_results/` (analysis output)
- **Included in Git**:
  - `divas_input_T1T2combined/` (44MB, pre-computed for convenience)

## Citation

If you use this workflow, please cite:

```
Prothero, J., ..., Marron J. S. (2024). 
Data integration via analysis of subspaces (DIVAS).
```

## Contact

For questions about this cell type analysis workflow:
- Issues: https://github.com/ByronSyun/DIVAS_COVID19_CaseStudy/issues
- DIVAS package: https://github.com/ByronSyun/DIVAS_Develop
